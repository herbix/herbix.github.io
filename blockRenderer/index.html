<html>
<head>
	<title>Minecraft Block Renderer</title>
	<script type="text/javascript" src="jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="Oak3D_v_0_5_9.js"></script>
	<script type="text/javascript" src="blockModel.js"></script>
	<script type="text/javascript" src="gllib.js"></script>
	<script type="text/javascript">
		var gl;

		function load() {
			loadPresets();

			gl = loadGl('canvas');

			gl.enable(gl.DEPTH_TEST);
			gl.depthFunc(gl.LESS);
			
			gl.enable(gl.BLEND);
			gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

			gl.enable(gl.CULL_FACE);
			gl.cullFace(gl.BACK);
			
			var done = 0;

			loadShader(gl, "#drawv", "#drawf", function(sp) {
				gl.dsp = sp;

				gl.linkProgram(sp);
				if (!gl.getProgramParameter(sp, gl.LINK_STATUS)) {
					alert("Could not link shaders: \n" + gl.getProgramInfoLog(sp));
					return;
				}
				
				sp.position = gl.getAttribLocation(sp, "position");
				sp.textureCoord = gl.getAttribLocation(sp, "textureCoord");
				sp.normal = gl.getAttribLocation(sp, "normal");
				
				sp.mvMatrix = gl.getUniformLocation(sp, "mvMatrix");
				sp.rtMatrix = gl.getUniformLocation(sp, "rtMatrix");
				sp.pMatrix = gl.getUniformLocation(sp, "pMatrix");
				sp.texture = gl.getUniformLocation(sp, "texture");
				
				done |= 1;
				doneThen(done, 3, gl);
			});
			
			loadModel(gl, block, function(lm) {
				gl.model = lm;
			
				done |= 2;
				doneThen(done, 3, gl);
			});

		}
		
		
		function doneThen(done, max, gl) {
			if(done != max)
				return;
			
			var scene = {};
			
			scene.mvMat = okMat4Trans(0, -8*1.732/2, 0).toArray();
			scene.rtMat = okMat4RotY(45).rotX(OAK.SPACE_WORLD, 30).toArray();
			scene.pMat = okMat4Ortho(-13, 13, 13, -13, -20, 20).toArray();
			
			gl.scene = scene;

			draw(scene, gl);
		}
		
		function draw(scene, gl) {
			var sp2 = gl.dsp;
			gl.useProgram(sp2);

			drawModel(gl, gl.model, {
				position: sp2.position,
				normal: sp2.normal,
				textureCoord: sp2.textureCoord,
				texture: sp2.texture,
				otherActions: function(gl, texture, polyhedron) {
					var sp = gl.dsp;
					
					gl.uniformMatrix4fv(sp.pMatrix, false, scene.pMat);
					gl.uniformMatrix4fv(sp.rtMatrix, false, scene.rtMat);
					gl.uniformMatrix4fv(sp.mvMatrix, false, scene.mvMat);
				}
			});
		}
		
		function loadPresets() {
			var list = [
				"bedrock",
				"bookshelf",
				"brick",
				"clay",
				"coal_block",
				"coal_ore",
				"cobblestone",
				"cobblestone_mossy",
				"command_block",
				"crafting_table_front",
				"crafting_table_side",
				"crafting_table_top",
				"diamond_block",
				"diamond_ore",
				"dirt",
				"dispenser_front_horizontal",
				"dispenser_front_vertical",
				"dropper_front_horizontal",
				"dropper_front_vertical",
				"emerald_block",
				"emerald_ore",
				"end_stone",
				"farmland_dry",
				"farmland_wet",
				"furnace_front_off",
				"furnace_front_on",
				"furnace_side",
				"furnace_top",
				"glowstone",
				"gold_block",
				"gold_ore",
				"grass_side",
				"grass_side_snowed",
				"grass_top",
				"gravel",
				"hardened_clay",
				"hardened_clay_stained_black",
				"hardened_clay_stained_blue",
				"hardened_clay_stained_brown",
				"hardened_clay_stained_cyan",
				"hardened_clay_stained_gray",
				"hardened_clay_stained_green",
				"hardened_clay_stained_light_blue",
				"hardened_clay_stained_lime",
				"hardened_clay_stained_magenta",
				"hardened_clay_stained_orange",
				"hardened_clay_stained_pink",
				"hardened_clay_stained_purple",
				"hardened_clay_stained_red",
				"hardened_clay_stained_silver",
				"hardened_clay_stained_white",
				"hardened_clay_stained_yellow",
				"hay_block_side",
				"hay_block_top",
				"ice",
				"iron_block",
				"iron_ore",
				"jukebox_side",
				"jukebox_top",
				"lapis_block",
				"lapis_ore",
				"log_acacia",
				"log_acacia_top",
				"log_big_oak",
				"log_big_oak_top",
				"log_birch",
				"log_birch_top",
				"log_jungle",
				"log_jungle_top",
				"log_oak",
				"log_oak_top",
				"log_spruce",
				"log_spruce_top",
				"melon_side",
				"melon_top",
				"mushroom_block_inside",
				"mushroom_block_skin_brown",
				"mushroom_block_skin_red",
				"mushroom_block_skin_stem",
				"mycelium_side",
				"mycelium_top",
				"netherrack",
				"nether_brick",
				"noteblock",
				"obsidian",
				"piston_bottom",
				"piston_inner",
				"piston_side",
				"piston_top_normal",
				"piston_top_sticky",
				"planks_birch",
				"planks_jungle",
				"planks_oak",
				"planks_spruce",
				"pumpkin_face_off",
				"pumpkin_face_on",
				"pumpkin_side",
				"pumpkin_top",
				"quartz_block_bottom",
				"quartz_block_chiseled",
				"quartz_block_chiseled_top",
				"quartz_block_lines",
				"quartz_block_lines_top",
				"quartz_block_side",
				"quartz_block_top",
				"quartz_ore",
				"redstone_block",
				"redstone_lamp_off",
				"redstone_lamp_on",
				"redstone_ore",
				"sand",
				"sandstone_bottom",
				"sandstone_carved",
				"sandstone_normal",
				"sandstone_smooth",
				"sandstone_top",
				"snow",
				"soul_sand",
				"sponge",
				"stone",
				"stonebrick",
				"stonebrick_carved",
				"stonebrick_cracked",
				"stonebrick_mossy",
				"stone_slab_side",
				"stone_slab_top",
				"tnt_bottom",
				"tnt_side",
				"tnt_top",
				"wool_colored_black",
				"wool_colored_blue",
				"wool_colored_brown",
				"wool_colored_cyan",
				"wool_colored_gray",
				"wool_colored_green",
				"wool_colored_light_blue",
				"wool_colored_lime",
				"wool_colored_magenta",
				"wool_colored_orange",
				"wool_colored_pink",
				"wool_colored_purple",
				"wool_colored_red",
				"wool_colored_silver",
				"wool_colored_white",
				"wool_colored_yellow"
			];
			var optstr = "";
			
			for(var i=0; i<list.length; i++) {
				optstr += "<option value='" + list[i] + "'>" + list[i] + "</option>";
			}
			
			$(".presets").html(optstr);
		}
		
		function changeTexture(o, i) {
			if(o.files.length < 0) {
				return;
			}
			
			var file = o.files[0];
			
			var reader = new FileReader(); 
			
			reader.onloadend = function() {
				if (reader.error) {
					alert("Error reading file.");
				} else {
					var s = reader.result;
					loadTexture(gl, {image:s, type:"solid", minFilter:"nearest", magFilter:"nearest"}, function(tx) {
						gl.model.textures[i] = tx;
						draw(gl.scene, gl);
					});
				}
			}

			reader.readAsDataURL(file);
		}
		
		function changeTexture2(o, i) {
			var s = "presets/" + $(o).val() + ".png";
			loadTexture(gl, {image:s, type:"solid", minFilter:"nearest", magFilter:"nearest"}, function(tx) {
				gl.model.textures[i] = tx;
				draw(gl.scene, gl);
			});
		}
		
		function changeTexture3(i, f) {
			gl.model.textures[i] = gl.model.textures[f];
			draw(gl.scene, gl);
		}
		
		function output() {
			draw(gl.scene, gl);
			var result = $("#result").get(0);
			result.href = $("#canvas").get(0).toDataURL("image/png");
		}
		
		function outputImage() {
			draw(gl.scene, gl);
			$('#result-img').get(0).src = $('#canvas').get(0).toDataURL('image/png');
		}
	</script>
</head>
<body onload="try{load();}catch(e){alert(e.message);}">
	<p id="drawv" style="display:none;">
attribute vec3 position;
attribute vec3 normal;
attribute vec2 textureCoord;

uniform mat4 mvMatrix;
uniform mat4 rtMatrix;
uniform mat4 pMatrix;

varying vec3 vNormal;
varying vec2 vTextureCoord;

void main(void) {
	gl_Position = pMatrix * mvMatrix * rtMatrix * vec4(position, 1.0);
	vNormal = normalize((rtMatrix * vec4(normal, 1.0)).xyz);
	vTextureCoord = textureCoord;
}


	</p>
	<p id="drawf" style="display:none;">
precision mediump float;

uniform sampler2D texture;

varying vec3 vNormal;
varying vec2 vTextureCoord;

void main(void) {
	vec4 color = texture2D(texture, vTextureCoord.st);
	vec3 normal = normalize(vNormal);
	vec3 light = normalize(vec3(-1, 1.732, 1));
	
	float lightWeight = dot(normal, light);
	if(lightWeight < 0.0)
		lightWeight = 0.0;

	lightWeight = 0.5 + 0.5 * lightWeight;

	gl_FragColor = vec4(color.rgb * lightWeight, 1.0);
}

	</p>
	<h1>Render minecraft blocks using WebGL.</h1>
	<canvas id="canvas" width="512" height="512" style="border:1px solid ccc;">
		Your browser doesn't support WelGL, or you need to enable it.
	</canvas>
	<p>All these textures' width and height must be power of 2 (e.g. 16, 32, 64, ...).</p>
	<table>
	<tr>
		<td>Top Side:</td>
		<td><select class="presets" onchange="changeTexture2(this, 0);"></select></td>
		<td><input type="file" onchange="changeTexture(this, 0);" /></td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td>Left Side:</td>
		<td><select class="presets" onchange="changeTexture2(this, 2);"></select></td>
		<td><input type="file" onchange="changeTexture(this, 2);" /></td>
		<td><a href="javascript:;" onclick="changeTexture3(2, 0);" >Same as Top</a></td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td>Right Side:</td>
		<td><select class="presets" onchange="changeTexture2(this, 1);" ></select></td>
		<td><input type="file" onchange="changeTexture(this, 1);" /></td>
		<td><a href="javascript:;" onclick="changeTexture3(1, 0);" >Same as Top</a></td>
		<td><a href="javascript:;" onclick="changeTexture3(1, 2);" >Same as Left</a></td>
	</tr>
	</table>
	<p>
		<a id="result" download="result.png" onclick="output()" href="javascript:;" target="__blank" type="application/octet-stream" >Save Result</a>
		<a href="javascript:;" onclick="outputImage()" >Render to Image Below(For IE11)</a>
	</p>
	<p><img id="result-img" /></p>
	<hr />
	<p>Author: Chaos</p>
	<p>E-Mail: <a href="mailto:herbix@163.com">herbix@163.com</a></p>
</body>
</html>
